image: node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d9e

definitions:
  services:
    docker:
      memory: 7128
  caches:
    yarn:
      key:
        files:
          - yarn.lock
      path: .temp/.yarn/berry/cache
    pnpm:
      key:
        files:
          - apps/svelte-app/yarn.lock
          - yarnrc.yml
      path: .temp/.yarn/berry/cache
    unplugged:
      key:
        files:
          - packages/unplugged/yarn.lock
      path: packages/unplugged/node_modules
  scripts:
    - script: &git-auth |
        git remote set-url origin https://${CI_BOT_USERNAME}:${CI_BOT_APP_SECRET}@bitbucket.org/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}
    - script: &env |
        export YARN_GLOBAL_FOLDER=.temp/.yarn/berry
        echo "YARN_GLOBAL_FOLDER=$YARN_GLOBAL_FOLDER" >> .env
    - script: &install |
        yarn config set globalFolder .temp/.yarn/berry
        yarn install
        yarn bootstrap
    - script: &setup |
        set -o pipefail
        nvm install
        corepack enable
        yarn install
        yarn playwright install --with-deps chromium
    - script: &check |
        yarn workspace $PACKAGE_NAME turbo run lint
        yarn workspace $PACKAGE_NAME turbo run build
    - script: &test |
        yarn workspace $PACKAGE_NAME turbo run coverage
    - script: &test-runner |
        npx concurrently -k -s first -n "SB,TEST" "yarn workspace $PACKAGE_NAME turbo run start -- --silent" "npx wait-on $(yarn workspace $PACKAGE_NAME g:dotenv-get TARGET_URL | tail -n1) && yarn workspace $PACKAGE_NAME coverage"
    - script: &chromatic |
        if [[ "$BITBUCKET_BRANCH" == main || "$BITBUCKET_BRANCH" == release-* ]]; then
          yarn workspace $PACKAGE_NAME turbo run build-storybook
          yarn workspace $PACKAGE_NAME chromatic --auto-accept-changes
        else
          yarn workspace $PACKAGE_NAME turbo run chromatic
        fi
    - script: &release |
        if [ "$RELEASE_TAGS" ]; then
          RELEASE_TAG=$( echo "$RELEASE_TAGS" | jq -r --arg keyvar "$BITBUCKET_BRANCH" --arg tag "$RELEASE_TAG" '.[$keyvar] // $tag' )
        fi

        BASE_REF="HEAD"
        if [[ "$STABLE" = true && "$BASE_REF_NAME" ]]; then
          BASE_REF="$BASE_REF_NAME"
        elif [[ "$BITBUCKET_BRANCH" == cherry-pick-* ]]; then
          PARTS=(${BITBUCKET_BRANCH//-/ })
          COUNT=${#PARTS[@]}
          COUNT=$((COUNT - 2))
          BASE_REF+="~$COUNT"
        elif [[ "$BITBUCKET_PR_DESTINATION_BRANCH" ]]; then
          BASE_REF=origin/$BITBUCKET_PR_DESTINATION_BRANCH
        else
          BASE_REF+="~1"
        fi

        if [ "$BASE_REF" ]; then
          echo BASE_REF="$BASE_REF" >> .env
        fi

        SEMVER=$(yarn apply-versions --strategy $STRATEGY)
        if [[ "$SEMVER" != "{}" ]]; then
          echo $SEMVER
          yarn build
        fi

        if [[ "$STRATEGY" != "build" ]]; then
          message="[skip ci] [DEV] Stable release"
          if [[ "$STRATEGY" == "launch" ]]; then
            message="[DEV] Launch release"
          fi
          git add .
          git commit -m "$message" || true
        fi

        if [[ "$SEMVER" != "{}" ]]; then
          if [ "$RELEASE_TAG" ]; then
            git tag -d "$RELEASE_TAG" || true
            git push origin --delete "$RELEASE_TAG" || true
            git tag "$RELEASE_TAG" -am "$SEMVER"
            git push origin "$RELEASE_TAG"
          fi
          yarn workspaces foreach -A --no-private --dry-run npm publish --tolerate-republish ${RELEASE_TAG:+--tag $RELEASE_TAG}
        fi

pipelines:
  branches:
    '{main,release-*}':
      - step: &build-root
          name: Build and Test Root
          max-time: 10
          size: 2x
          caches:
            - yarn
          script:
            - yarn install
            - yarn turbo run //#lint
      - parallel: &build-workspaces
          - step:
              name: Build and Test Commons
              max-time: 10
              size: 2x
              condition:
                changesets:
                  includePaths:
                    - package.json
                    - packages/commons/**
              caches:
                - yarn
              script:
                - *env
                - export PACKAGE_NAME=commons
                - yarn install
                - *test
          - step:
              name: Build and Test Stylelint Config
              max-time: 10
              size: 2x
              condition:
                changesets:
                  includePaths:
                    - *env
                    - package.json
                    - packages/commons/**
                    - packages/stylelint-config/**
              caches:
                - yarn
              script:
                - *env
                - export PACKAGE_NAME=stylelint-config
                - yarn install
                - *test
          - step:
              name: Build and Test HTML UI
              image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
              max-time: 15
              size: 2x
              caches:
                - yarn
              condition:
                changesets:
                  includePaths:
                    - package.json
                    - packages/commons/**
                    - packages/stylelint-config/**
                    - packages/html-ui/**
              script:
                - *env
                - export PACKAGE_NAME=html-ui
                - *setup
                - *check
                - *test-runner
                - *chromatic
          - step:
              name: Build and Test React UI
              image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
              max-time: 15
              size: 2x
              caches:
                - yarn
              clone:
                enabled: true
                depth: 75
              condition:
                changesets:
                  includePaths:
                    - package.json
                    - packages/commons/**
                    - packages/stylelint-config/**
                    - packages/html-ui/**
                    - packages/react-ui/**
              script:
                - *env
                - export PACKAGE_NAME=react-ui
                - *setup
                - *check
                - *test
                - *chromatic
          - step:
              name: Build and Test Next App
              max-time: 15
              size: 2x
              caches:
                - yarn
              clone:
                enabled: true
                depth: 75
              condition:
                changesets:
                  includePaths:
                    - package.json
                    - packages/commons/**
                    - packages/html-ui/**
                    - packages/react-ui/**
                    - apps/next-app/**
              script:
                - *env
                - export PACKAGE_NAME=next-app
                - yarn install
                - *test
          - step:
              name: Build and Test Svelte App
              max-time: 15
              size: 2x
              caches:
                - pnpm
                - unplugged
              condition:
                changesets:
                  includePaths:
                    - package.json
                    - bin/bootstrap.ts
                    - packages/commons/**
                    - packages/html-ui/**
                    - apps/svelte-app/**
              script:
                - *env
                - export PACKAGE_NAME=svelte-app
                - corepack enable
                - *install
                - *test
      - step: &build-releases
          name: Release
          image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
          max-time: 25
          size: 2x
          caches:
            - pnpm
            - unplugged
          clone:
            enabled: true
            depth: 75
          condition:
            changesets:
              includePaths:
                - .yarn/versions/**
                - apps/**
                - packages/**
          script:
            - *env
            - >-
              export STABLE=$( [[ "$BITBUCKET_BRANCH" == release-* ]] && echo
              "true" || echo "false" )
            - >-
              export STRATEGY=$( [ "$STABLE" = true ] &&   echo "stable" || echo
              "build" )
            - *git-auth
            - |
              if [ "$STABLE" = true ]; then
                git fetch --depth=50 origin "$BASE_REF_NAME":"$BASE_REF_NAME"
              fi
            - nvm install
            - corepack enable
            - *install
            - *release
            - '[ "$STABLE" = true ] && git push || true'

  pull-requests:
    '**':
      - step:
          name: Prepare Version Strategy
          image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
          max-time: 15
          size: 2x
          caches:
            - pnpm
            - unplugged
          clone:
            enabled: true
            depth: 75
          script:
            - *env
            - git fetch --depth=1 origin $BITBUCKET_PR_DESTINATION_BRANCH
            - echo "BASE_REF=origin/$BITBUCKET_PR_DESTINATION_BRANCH" >> .env
            - nvm install
            - corepack enable
            - set +e
            - yarn version check
            - export CHECK_STATUS=$?
            - set -e
            - '[ $CHECK_STATUS = 0 ] && exit 0 || true'
            - >-
              [[ "$BITBUCKET_BRANCH" != issue/* && "$BITBUCKET_BRANCH" !=
              feature/* ]] && exit 1 || true
            - >-
              export APPLY_STRATEGY=$( [[ "$BITBUCKET_BRANCH" == issue/* ]] &&
              echo "patch" || echo "minor" )
            - *git-auth
            - git fetch --depth=1 origin $BITBUCKET_PR_DESTINATION_BRANCH
            - echo "BASE_REF=origin/$BITBUCKET_PR_DESTINATION_BRANCH" >> .env
            - *install
            - rm -rf .yarn/versions || true
            - export SEMVER=$( yarn apply-versions --strategy $APPLY_STRATEGY )
            - git stash
            - |
              if [[ "$SEMVER" && "$SEMVER" != "{}" ]]; then
                yarn workspaces foreach -A --no-private exec 'test $(echo $SEMVER | jq .\"$npm_package_name\") = null || yarn version $APPLY_STRATEGY --deferred'
                git add .
                git commit -m "[skip ci] [DEV] Add Version Strategy"
                git push
              fi
      - step: *build-root
      - parallel: *build-workspaces
      - step: *build-releases
  custom:
    launch:
      - variables:
          - name: REF_NAME
            description: The branch name you wish to create for the release
            default: release-
      - step:
          name: Create new releases
          image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
          max-time: 15
          size: 2x
          caches:
            - pnpm
            - unplugged
          clone:
            enabled: true
            depth: full
          script:
            - *env
            - export STABLE=true
            - export STRATEGY=launch
            - export BASE_REF_NAME=$(git branch --show-current)
            - *git-auth
            - corepack enable
            - *install
            - *release
            - git push
            - git checkout -b $REF_NAME
            - git push --set-upstream origin $REF_NAME
    prepare:
      - variables:
          - name: COMMITS
            description:
              One or more commits that you wish to cherry-pick into the target
              branch
      - step:
          name: Create a PR with cherry-picked commits
          image: atlassian/default-image:4@sha256:71960b111dfa043daa26d7c794b70b40385371edea552e94b3ab05b0a5999796
          max-time: 15
          clone:
            enabled: true
            depth: 75
          script:
            - *env
            - *git-auth
            - export BASE_REF_NAME=$(git branch --show-current)
            - |
              source ./bin/git-ls-unmerged.sh
              export SHORT=$OUTPUT
            - export BASE_REF=cherry-pick-$SHORT
            - '[ ! $REF ] && exit 1 || true'
            - git fetch --depth=2 origin $REF
            - git cherry-pick -x $REF || true
            - git add .
            - git cherry-pick --continue || true
            - git checkout -b $BASE_REF
            - git push -u origin $BASE_REF
            - >-
              curl
              https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests
              -u "$CI_BOT_USERNAME":"$CI_BOT_APP_SECRET" --request POST --header
              "Content-Type: application/json" --data "{
                \"title\": \"Cherry Pick ${SHORT//-/ } into $BASE_REF_NAME\",
                \"source\": {
                  \"branch\": {
                    \"name\": \"$BASE_REF\"
                  }
                },
                \"destination\": {
                  \"branch\": {
                    \"name\": \"$BASE_REF_NAME\"
                  }
                },
                \"reviewers\": [
                  {
                    \"uuid\": \"$BITBUCKET_STEP_TRIGGERER_UUID\"
                  }
                ],
                \"close_source_branch\": true
              }"

    renovate:
      - step:
          image: renovate/renovate:latest@sha256:1954b301dbf895d1de2cc2b6ac14222a3a3a090d1630ee318f967ec6b1062a23
          size: 2x
          caches:
            - yarn
          script:
            - *env
            - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
            - set +e
            - . ~/.nvm/nvm.sh
            - export CHECK_STATUS=$?
            - set -e
            - '[ $CHECK_STATUS != 0 ] && exit $CHECK_STATUS || true'
            - nvm install
            - corepack enable
            - yarn install
            - export LOG_LEVEL=debug
            - export RENOVATE_CONFIG_FILE=renovate.config.cjs
            - renovate
