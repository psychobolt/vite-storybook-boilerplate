image: node:lts-alpine@sha256:cb2301e2c5fe3165ba2616591efe53b4b6223849ac0871c138f56d5f7ae8be4b

definitions:
  services:
    docker:
      memory: 7128
  caches:
    yarn-a3e20043522c3d0e:
      key:
        files:
          - yarn.lock
      path: .yarn/cache
    svelte-app-a3e20043522c3d0e:
      key:
        files:
          - apps/svelte-app/yarn.lock
      path: apps/svelte-app/node_modules
  scripts:
    - script: &env >-
        export YARN_ENABLE_GLOBAL_CACHE=false
    - script: &setup >-
        export DOTENV_KEY=$(echo $DOTENV_KEYS | jq -r --arg keyvar $PACKAGE_NAME
        '.[$keyvar]') && nvm install --lts && nvm use --lts && corepack enable
        && corepack prepare yarn@stable --activate && yarn install && yarn
        playwright install --with-deps chromium
    - script: &test >-
        yarn workspace $PACKAGE_NAME turbo run lint && yarn workspace
        $PACKAGE_NAME turbo run build
    - script: &chromatic >-
        yarn dlx concurrently -k -s first -n "SB,TEST" "yarn workspace
        $PACKAGE_NAME start --silent" "yarn dlx wait-on $(yarn workspace
        $PACKAGE_NAME g:dotenv -p TARGET_URL | tail -n1) &&  yarn workspace
        $PACKAGE_NAME coverage" && yarn workspace $PACKAGE_NAME chromatic
        --exit-once-uploaded

pipelines:
  default:
    - step:
        name: Build and Test Root
        max-time: 10
        caches:
          - yarn-a3e20043522c3d0e
        script:
          - *env
          - yarn install
          - yarn bootstrap
          - yarn turbo run //#lint
    - parallel:
        - step:
            name: Build and Test Commons
            max-time: 5
            condition:
              changesets:
                includePaths:
                  - packages/commons/**
            caches:
              - yarn-a3e20043522c3d0e
            script:
              - *env
              - export PACKAGE_NAME=commons
              - yarn install
              - *test
        - step:
            name: Build and Test HTML UI
            image: atlassian/default-image:4@sha256:50233cc29af9aeb0f8b949064e82f5a81436f8e5a32bf32fb6626751d96884ac
            max-time: 15
            caches:
              - yarn-a3e20043522c3d0e
            condition:
              changesets:
                includePaths:
                  - packages/commons/**
                  - packages/html-ui/**
            script:
              - *env
              - export PACKAGE_NAME=html-ui
              - *setup
              - *test
              - *chromatic
        - step:
            name: Build and Test React UI
            image: atlassian/default-image:4@sha256:50233cc29af9aeb0f8b949064e82f5a81436f8e5a32bf32fb6626751d96884ac
            max-time: 15
            caches:
              - yarn-a3e20043522c3d0e
            condition:
              changesets:
                includePaths:
                  - packages/commons/**
                  - packages/html-ui/**
                  - packages/react-ui/**
            script:
              - *env
              - export PACKAGE_NAME=react-ui
              - *setup
              - *test
              - *chromatic
        - step:
            name: Build and Test Next App
            max-time: 15
            caches:
              - yarn-a3e20043522c3d0e
            condition:
              changesets:
                includePaths:
                  - packages/commons/**
                  - packages/react-ui/**
                  - apps/next-app/**
            script:
              - *env
              - export PACKAGE_NAME=next-app
              - yarn install
              - *test
        - step:
            name: Build and Test Svelte App
            max-time: 15
            caches:
              - yarn-a3e20043522c3d0e
              - svelte-app-a3e20043522c3d0e
            condition:
              changesets:
                includePaths:
                  - packages/commons/**
                  - packages/react-ui/**
                  - apps/svelte-app/**

            script:
              - *env
              - export PACKAGE_NAME=svelte-app
              - yarn install
              - yarn bootstrap
              - *test
  custom:
    renovate:
      - step:
          size: 2x
          script:
            - pipe: atlassian/renovate-scan:0.4.1
              variables:
                CONFIG_FILE_PATH: renovate.json
                GITHUB_COM_TOKEN: $GITHUB_COM_TOKEN
