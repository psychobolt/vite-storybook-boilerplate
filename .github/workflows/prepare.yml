name: Prepare

on:
  workflow_dispatch:
    inputs:
      commits:
        description: One or more commits that you wish to cherry-pick into base_ref
        type: string
        required: true

jobs:
  unmerged_commits:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.unmerged.outputs.ref }}
      short: ${{ steps.unmerged.outputs.commits }}
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 50
      - name: Filter commits not found in ${{ github.ref_name }}
        id: unmerged
        run: |
          source ./scripts/git-ls-unmerged.sh
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "commits=$OUTPUT" >> $GITHUB_OUTPUT
        env:
          COMMITS: ${{ inputs.commits }}
          BASE_REF: ${{ github.ref_name }}
  create-branch:
    needs: unmerged_commits
    if: needs.unmerged_commits.outputs.ref != ''
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - name: Fetch commits
        run: git fetch --depth=1 origin ${{ needs.unmerged_commits.outputs.ref }}
      - name: Branch
        run: git branch ci/cherry-pick-${{ needs.unmerged_commits.outputs.short }}
      - name: Cherry pick
        run: git cherry-pick ${{ needs.unmerged_commits.outputs.ref }}
      - name: Push
        run: git push
