name: Prepare

on:
  workflow_dispatch:
    inputs:
      commits:
        description: One or more commits that you wish to cherry-pick into base_ref
        type: string
        required: true

jobs:
  unmerged_commits:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      ref: ${{ steps.unmerged.outputs.ref }}
      short: ${{ steps.unmerged.outputs.commits }}
      count: ${{ steps.unmerged.outputs.count }}
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 50
      - name: Filter commits not found in ${{ github.ref_name }}
        id: unmerged
        run: |
          source ./scripts/git-ls-unmerged.sh
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "commits=$OUTPUT" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        env:
          COMMITS: ${{ inputs.commits }}
          BASE_REF: ${{ github.ref_name }}

  create-branch:
    needs: unmerged_commits
    if: needs.unmerged_commits.outputs.ref != ''
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      ref_name: ${{ env.BASE_REF }}
    env:
      BASE_REF: cherry-pick-${{ needs.unmerged_commits.outputs.short }}
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - name: Fetch commits
        run: git fetch --depth=2 origin ${{ needs.unmerged_commits.outputs.ref }}
      - name: Configure git user
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Cherry pick
        run: git cherry-pick -x ${{ needs.unmerged_commits.outputs.ref }}
      - name: Branch
        run: git checkout -b ${{ env.BASE_REF }}
      - name: Push
        run: git push -u origin ${{ env.BASE_REF }}

  ci:
    needs: [unmerged_commits, create-branch]
    uses: ./.github/workflows/ci.yml
    with:
      ref_name: ${{ needs.create-branch.outputs.ref_name }}
    secrets: inherit

  apps:
    needs: [unmerged_commits, create-branch]
    uses: ./.github/workflows/apps.yml
    with:
      ref_name: ${{ needs.create-branch.outputs.ref_name }}
      change-from: HEAD~${{ needs.unmerged_commits.outputs.count }}
    secrets: inherit

  packages:
    needs: [unmerged_commits, create-branch]
    uses: ./.github/workflows/packages.yml
    with:
      ref_name: ${{ needs.create-branch.outputs.ref_name }}
      change-from: HEAD~${{ needs.unmerged_commits.outputs.count }}
    secrets: inherit

  merge_branch:
    needs: [create-branch, ci, apps, packages]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          token: ${{ secrets.GH_ACTIONS_TOKEN }}
      - name: Fetch branch
        run: git fetch --depth=50 origin ${{ needs.create-branch.outputs.ref_name }}:${{ needs.create-branch.outputs.ref_name }}
      - name: Configure git user
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Merge
        run: git merge ${{ needs.create-branch.outputs.ref_name }}
      - name: Push
        run: git push
      - name: Delete branch
        run: git push -d origin ${{ needs.create-branch.outputs.ref_name }}
