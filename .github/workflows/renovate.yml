name: Renovate

on:
  pull_request:
    paths:
      - '**/yarn.lock'
  workflow_dispatch:
    inputs:
      force:
        type: boolean
        default: false

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      duplicate: ${{ steps.check_duplicated_workflow.outputs.should_skip }}
    steps:
      - id: check_duplicated_workflow
        uses: fkirc/skip-duplicate-actions@v5
        with:
          do_not_skip: '["schedule"]'
  check:
    needs: init
    if: needs.init.outputs.duplicate != 'true' && (inputs.force || (github.repository == 'psychobolt/vite-storybook-boilerplate' && startsWith(github.head_ref, 'renovate/') && github.actor == 'renovate[bot]'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      conclusion: ${{ steps.build_status.outputs.conclusion }}
    steps:
      - name: Wait for CI workflow to complete
        uses: fountainhead/action-wait-for-check@v1.1.0
        id: build_status
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          checkName: Build and Test (ubuntu-latest)
          token: ${{ secrets.GITHUB_TOKEN }}
  post-upgrade:
    needs: check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: inputs.force || needs.check.outputs.conclusion == 'failure' || needs.check.outputs.conclusion == 'cancelled'
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.head_ref }}
          token: ${{ secrets.RENOVATE_GH_TOKEN }}
      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
          cache: yarn
      - name: Unpack binaries
        run: YARN_ENABLE_IMMUTABLE_INSTALLS=false yarn install
      - name: Validate dependencies
        run: YARN_ENABLE_IMMUTABLE_INSTALLS=false yarn bootstrap
      - name: Update previous commit
        run: |
          git config user.name "$(git --no-pager log --format=format:'%an' -n 1)"
          git config user.email "$(git --no-pager log --format=format:'%ae' -n 1)"
          git add .
          git commit -C HEAD --amend
          git push --force
